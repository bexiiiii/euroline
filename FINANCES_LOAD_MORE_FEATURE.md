# Добавление кнопки "Показать больше" для таблиц финансов

## Проблема
После ограничения количества записей в таблицах (10 для пополнений, 15 для транзакций) пользователи не могли видеть остальные записи.

## Решение

Добавлена функциональность **"Показать больше"** с пагинацией для обеих таблиц.

### Реализованные функции

#### 1. **Состояние пагинации**
```typescript
const [topUpsPage, setTopUpsPage] = useState(0)
const [txnsPage, setTxnsPage] = useState(0)
const [loadingMoreTopUps, setLoadingMoreTopUps] = useState(false)
const [loadingMoreTxns, setLoadingMoreTxns] = useState(false)
```

#### 2. **Функция загрузки дополнительных пополнений**
```typescript
const loadMoreTopUps = async () => {
  if (!topUps || loadingMoreTopUps) return
  setLoadingMoreTopUps(true)
  try {
    const nextPage = topUpsPage + 1
    const moreTopUps = await getMyTopUps(nextPage, 10)
    setTopUps({
      ...moreTopUps,
      content: [...topUps.content, ...moreTopUps.content] // добавляем к существующим
    })
    setTopUpsPage(nextPage)
  } catch (e: any) {
    toast.error('Не удалось загрузить больше пополнений')
  } finally {
    setLoadingMoreTopUps(false)
  }
}
```

#### 3. **Функция загрузки дополнительных транзакций**
```typescript
const loadMoreTxns = async () => {
  if (!txns || loadingMoreTxns) return
  setLoadingMoreTxns(true)
  try {
    const nextPage = txnsPage + 1
    const moreTxns = await getMyTransactions(nextPage, 15)
    setTxns({
      ...moreTxns,
      content: [...txns.content, ...moreTxns.content] // добавляем к существующим
    })
    setTxnsPage(nextPage)
  } catch (e: any) {
    toast.error('Не удалось загрузить больше транзакций')
  } finally {
    setLoadingMoreTxns(false)
  }
}
```

#### 4. **UI компонент с кнопкой**

**Для истории пополнений:**
```tsx
{topUps && topUps.totalElements > topUps.content.length && (
  <div className="flex flex-col items-center gap-2 pt-3 border-t mt-2">
    <div className="text-xs text-muted-foreground">
      Показано {topUps.content.length} из {topUps.totalElements} записей
    </div>
    <Button 
      variant="outline" 
      size="sm" 
      onClick={loadMoreTopUps}
      disabled={loadingMoreTopUps}
      className="w-full max-w-xs"
    >
      {loadingMoreTopUps ? 'Загрузка...' : 'Показать больше'}
    </Button>
  </div>
)}
```

**Для истории транзакций:**
```tsx
{txns.totalElements > txns.content.length && (
  <div className="flex flex-col items-center gap-2 pt-3 border-t mt-2">
    <div className="text-xs text-muted-foreground">
      Показано {txns.content.length} из {txns.totalElements} записей
    </div>
    <Button 
      variant="outline" 
      size="sm" 
      onClick={loadMoreTxns}
      disabled={loadingMoreTxns}
      className="w-full max-w-xs"
    >
      {loadingMoreTxns ? 'Загрузка...' : 'Показать больше'}
    </Button>
  </div>
)}
```

## Как это работает

### 📊 Визуальный процесс:

**Шаг 1: Начальная загрузка**
```
┌─────────────────────────────┐
│ История пополнений          │
├─────────────────────────────┤
│ Запись 1                    │
│ Запись 2                    │
│ ...                         │
│ Запись 10                   │
├─────────────────────────────┤
│ Показано 10 из 45 записей   │
│ [Показать больше]           │ ← Кнопка появляется
└─────────────────────────────┘
```

**Шаг 2: После нажатия "Показать больше"**
```
┌─────────────────────────────┐
│ История пополнений          │
├─────────────────────────────┤
│ Запись 1                    │
│ Запись 2                    │
│ ...                         │
│ Запись 10                   │
│ Запись 11 ← новые           │
│ ...                         │
│ Запись 20                   │
├─────────────────────────────┤
│ Показано 20 из 45 записей   │
│ [Показать больше]           │ ← Кнопка остается
└─────────────────────────────┘
```

**Шаг 3: Все записи загружены**
```
┌─────────────────────────────┐
│ История пополнений          │
├─────────────────────────────┤
│ Запись 1                    │
│ Запись 2                    │
│ ...                         │
│ Запись 45                   │
└─────────────────────────────┘
  (кнопка исчезает)
```

## Логика пагинации

### Начальная загрузка
- **Страница 0**: Загружается 10 записей пополнений
- **Страница 0**: Загружается 15 записей транзакций

### При нажатии "Показать больше"
1. Увеличивается номер страницы (`topUpsPage++`)
2. Загружаются следующие 10/15 записей
3. Новые записи **добавляются** к существующим (не заменяют)
4. Обновляется счетчик отображаемых записей
5. Если загружены все записи, кнопка скрывается

### Формула
```typescript
Показано записей = (страница + 1) × размер_страницы
Всего записей = topUps.totalElements

Показать кнопку = показано < всего
```

## Преимущества

### 1. **Производительность** ⚡
- ✅ Изначально загружается минимум данных
- ✅ Дополнительные данные загружаются по требованию
- ✅ Не перегружается сервер и клиент

### 2. **UX (Пользовательский опыт)** 👤
- ✅ Компактный интерфейс при первой загрузке
- ✅ Простое управление - одна кнопка
- ✅ Видно сколько записей загружено и сколько всего
- ✅ Индикация загрузки (текст меняется на "Загрузка...")
- ✅ Кнопка автоматически скрывается когда все загружено

### 3. **Адаптивность** 📱
- ✅ Работает на всех устройствах
- ✅ Кнопка адаптируется под ширину контейнера
- ✅ Таблица остается с фиксированной высотой и прокруткой

### 4. **Обработка ошибок** 🛡️
- ✅ Toast уведомления при ошибке загрузки
- ✅ Кнопка не блокируется при ошибке
- ✅ Можно повторить попытку загрузки

## Технические детали

### Состояния кнопки

| Условие | Состояние кнопки |
|---------|------------------|
| Загружено все записи | Скрыта |
| Идет загрузка | Заблокирована, текст "Загрузка..." |
| Готова к загрузке | Активна, текст "Показать больше" |
| Ошибка загрузки | Активна (можно повторить) |

### Объединение данных

При каждой загрузке новые записи добавляются к существующим:

```typescript
setTopUps({
  ...moreTopUps,                           // метаданные (totalElements, totalPages, etc)
  content: [...topUps.content, ...moreTopUps.content]  // старые + новые записи
})
```

### Предотвращение дублей

- Используется `key={t.id}` для уникальной идентификации записей
- React автоматически обрабатывает дубликаты

## Альтернативные подходы (не реализованы)

### 1. Infinite Scroll (Бесконечная прокрутка)
```typescript
// Загрузка при достижении конца списка
const handleScroll = (e) => {
  const bottom = e.target.scrollHeight - e.target.scrollTop === e.target.clientHeight
  if (bottom) loadMore()
}
```

**Плюсы:** Автоматическая загрузка, удобно для длинных списков
**Минусы:** Сложнее контролировать, может нагружать сервер

### 2. "Показать все" (Load All)
```typescript
const loadAll = async () => {
  const all = await getMyTopUps(0, topUps.totalElements)
  setTopUps(all)
}
```

**Плюсы:** Один клик - все данные
**Минусы:** Может загрузить слишком много, медленно

### 3. Классическая пагинация (1, 2, 3...)
```typescript
<Pagination>
  <Page number={1} />
  <Page number={2} />
  <Page number={3} />
</Pagination>
```

**Плюсы:** Традиционный подход, легко навигировать
**Минусы:** Теряется контекст, нужно больше кликов

## Тестирование

### Сценарий 1: Загрузка дополнительных пополнений
1. Откройте страницу `/finances`
2. Убедитесь что показано 10 записей
3. Нажмите "Показать больше" под таблицей пополнений
4. Должны загрузиться еще 10 записей (всего 20)
5. Счетчик обновится: "Показано 20 из X"

### Сценарий 2: Загрузка дополнительных транзакций
1. Прокрутите до таблицы транзакций
2. Нажмите "Показать больше" под таблицей транзакций
3. Должны загрузиться еще 15 записей
4. Счетчик обновится

### Сценарий 3: Загрузка всех записей
1. Нажимайте "Показать больше" несколько раз
2. Когда загружены все записи, кнопка должна исчезнуть

### Сценарий 4: Состояние загрузки
1. Нажмите "Показать больше"
2. Текст кнопки меняется на "Загрузка..."
3. Кнопка заблокирована
4. После загрузки кнопка снова активна

### Сценарий 5: Обработка ошибок
1. Отключите интернет
2. Нажмите "Показать больше"
3. Должно появиться toast сообщение об ошибке
4. Кнопка остается активной для повторной попытки

## Будущие улучшения

1. **Кэширование данных**
   - Сохранять загруженные страницы в localStorage
   - Не перезагружать при возврате на страницу

2. **Предзагрузка**
   - Загружать следующую страницу заранее
   - Мгновенное отображение при клике

3. **Виртуализация**
   - Отрисовывать только видимые строки
   - Улучшенная производительность для больших списков

4. **Фильтры**
   - Фильтрация по дате
   - Фильтрация по статусу
   - Поиск по описанию

5. **Сортировка**
   - По дате (по возрастанию/убыванию)
   - По сумме
   - По статусу

## Файлы

- ✅ `/autoparts/app/(routes)/finances/page.tsx` - обновлен с пагинацией
- ✅ `FINANCES_LOAD_MORE_FEATURE.md` - эта документация

## Совместимость

- ✅ Работает со всеми браузерами
- ✅ Мобильные устройства поддерживаются
- ✅ Обратно совместимо с API
- ✅ Не влияет на другие страницы
