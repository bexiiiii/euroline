# RabbitMQ Consumer Debugging Guide

## –ü—Ä–æ–±–ª–µ–º–∞
–í –æ—á–µ—Ä–µ–¥–∏ `orders.export.q` –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å **690 —Å–æ–æ–±—â–µ–Ω–∏–π**, –Ω–æ consumer –∏—Ö –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.

## –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏

### 1. –î–æ–±–∞–≤–∏–ª–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ `OrdersExportConsumer` —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
- ‚úÖ `JobQueue` –ª–æ–≥–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω error handler –≤ `RabbitConfig`
- ‚úÖ –í–∫–ª—é—á–µ–Ω–æ DEBUG –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Spring AMQP

### 2. –°–æ–∑–¥–∞–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–π consumer
- ‚úÖ `TestOrdersConsumer` - —Å–ª—É—à–∞–µ—Ç —Ç—É –∂–µ –æ—á–µ—Ä–µ–¥—å `orders.export.q`
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç RAW —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 3. –î–æ–±–∞–≤–∏–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ endpoints

#### –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –æ—á–µ—Ä–µ–¥—è—Ö
```bash
curl http://localhost:8080/api/diagnostic/rabbitmq/queue-info
```

#### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ DLQ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)
```bash
curl http://localhost:8080/api/diagnostic/rabbitmq/peek-dlq
```

#### –°—Ç–∞—Ç—É—Å listeners
```bash
curl http://localhost:8080/api/diagnostic/rabbitmq/listener-status
```

#### –†—É—á–Ω–æ–π —Ç—Ä–∏–≥–≥–µ—Ä —ç–∫—Å–ø–æ—Ä—Ç–∞ (–¥–ª—è —Ç–µ—Å—Ç–∞)
```bash
curl -X POST http://localhost:8080/api/diagnostic/trigger-order-export
```

## –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–ò—â–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:
```
üöÄ OrdersExportConsumer initialized
‚úÖ OrdersExportConsumer PostConstruct completed
üß™ TestOrdersConsumer CREATED
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:
```
üß™üß™üß™ TEST CONSUMER RECEIVED MESSAGE!
üì• RECEIVED message in OrdersExportConsumer
```

–ï—Å–ª–∏ `TestOrdersConsumer` –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ `OrdersExportConsumer` –Ω–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ –≤ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `ExchangeJob`.

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DLQ
```bash
curl http://localhost:8080/api/diagnostic/rabbitmq/peek-dlq
```

–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ —Å–º–æ–≥–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è, –∏ –µ–≥–æ error headers.

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥ –æ—à–∏–±–æ–∫
–ò—â–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:
```
‚ùå RabbitMQ Listener Error:
```

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

### 1. –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è ExchangeJob
–ï—Å–ª–∏ Jackson –Ω–µ –º–æ–∂–µ—Ç –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å record, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
```java
@JsonCreator
public record ExchangeJob(...)
```

### 2. Consumer –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `@EnableRabbit` –µ—Å—Ç—å
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `rabbitListenerContainerFactory` —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Spring –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

### 3. –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ RabbitMQ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—á–µ—Ä–µ–¥–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å bindings –º–µ–∂–¥—É exchange –∏ queue
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å routing key

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** –∏ —Å–æ–±–µ—Ä–∏—Ç–µ –ª–æ–≥–∏
2. **–í—ã–∑–æ–≤–∏—Ç–µ** `/api/diagnostic/rabbitmq/peek-dlq` —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫—É
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ** –ø–æ—è–≤–ª—è—é—Ç—Å—è –ª–∏ –ª–æ–≥–∏ –æ—Ç `TestOrdersConsumer`
4. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ** –º–Ω–µ –ª–æ–≥–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

## –í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### RabbitConfig.java
- –î–æ–±–∞–≤–ª–µ–Ω `AmqpAdmin` bean
- –î–æ–±–∞–≤–ª–µ–Ω error handler –≤ listener container factory
- –í–∫–ª—é—á–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

### application.yml
- –î–æ–±–∞–≤–ª–µ–Ω–æ DEBUG –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è `org.springframework.amqp`

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
- `DiagnosticController.java` - —Ä—É—á–Ω–æ–π —Ç—Ä–∏–≥–≥–µ—Ä —ç–∫—Å–ø–æ—Ä—Ç–∞
- `RabbitMqDiagnosticController.java` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ RabbitMQ
- `TestOrdersConsumer.java` - —Ç–µ—Å—Ç–æ–≤—ã–π consumer –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
